---
title: "survival modeling with radiomic features"
author: "Christelle Colin-Leitzinger"
date: '`r Sys.Date()`'
output: 
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: false
    theme: united
    highlight: pygments
    df_print: paged
editor_options: 
  chunk_output_type: console
---

<style type="text/css">
.figure {
   margin-top: 25px;
   margin-bottom: 10px;
}

table {
    margin-top: 10px;
    margin-bottom: 25px;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      cache = FALSE,
                      # fig.width = 7, fig.height = 5, 
                      fig.align='center'#, fig.show='hold'
                      )
options(gtsummary.print_engine = "gt")
options(gtsummary.as_gt.addl_cmds = "gt::tab_options(table.font.size = 14, data_row.padding = gt::px(1))")
```

<style>
div.blue { background-color:#FF9966; border-radius: 5px; padding: 20px; font-size: 38px}
</style>
<div class = "blue">

<span style="color: white;">Recurrence prediction</span>

</div>
<br>

```{r library}
library(tidyverse)
library(tidymodels)
# library(dotwhisker)  # for visualizing regression results
# library(themis)
library(gtsummary)
# library(gplots)
library(ggcorrplot)
library(survminer)
library(survival)
library(rpart.plot)
library(rattle)
library(xgboost)
# library(kknn)
# library(vip) 
```


```{r load}
clinical <- read_rds(paste0(here::here(), "/clinical.rds")) %>% 
  select(mrn, 
         has_the_patient_recurred, vital_new, 
         rec_event, recurrence_time, os_event, os_time,
         age_at_diagnosis, tnm_cs_mixed_group_stage, 
         treatment_type, debulking_status,
         raceeth)

concordanceCCC <- read_rds("/Users/colinccm/Documents/GitHub/Peres/MilesForMoffittRadiomics/concordanceCCC.rds") %>%
  filter(value_CCC >= 0.95) %>%
  select(name) %>%
  mutate(stable_features = str_match(name, "([a-z][:digit:]*)_*")[,2])

concordance <- read_rds("/Users/colinccm/Documents/GitHub/Peres/MilesForMoffittRadiomics/concordance_cor.rds") %>% 
  mutate(stable_features = str_match(namee, "([a-z][:digit:]*)_*")[,2])

stable_features <- paste0(paste(#"nor_", 
                                concordance$stable_features, "[a-z]", sep = ""), collapse = "|")

rec_data <- read_rds(paste0(here::here(), "/radiomics.rds")) %>% 
  filter(contrastenhancementyn == "yes") %>% 
  select(mrn, matches(stable_features)) %>% 
  inner_join(., clinical,
             by = "mrn")
```

# Stable features

`r nrow(concordanceCCC)` stable features were selected after concordance analysis with a concordance â‰¥ 0.95.  
Jaileene performed the pearson correlation selection using Ilke's matlab code.  
`r nrow(concordance)` stable features were selected after the cleaning.  


## Impact of features on HR for further selection

### Features by outcome status
```{r}
rec_data %>% select(matches("^f[0-9]"), has_the_patient_recurred) %>%
  tbl_summary(by = has_the_patient_recurred,
              sort = list(everything() ~ "frequency"),
              digits = list(everything() ~  2)) %>%
  bold_labels() %>% add_p() %>% bold_p(t = .05)

# rec_data %>% select(matches("^f[0-9]"), treatment_type) %>%
#   tbl_summary(by = treatment_type,
#               sort = list(everything() ~ "frequency"),
#               digits = list(everything() ~  2)) %>%
#   bold_labels() %>% add_p() %>% bold_p(t = .05)
```

### HR of recurrence
```{r}
tbl1 <- rec_data %>% select(matches("^f[0-9]"), rec_event, recurrence_time) %>%
  tbl_uvregression(method = survival::coxph,
                   y = (Surv(time = rec_data$recurrence_time,
                             event = rec_data$rec_event)),
                   exponentiate = TRUE) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level") %>%
  bold_labels() %>% italicize_levels()
tbl1

concordance <- tbl1$table_body %>% filter(p.value < 0.1) %>% select(variable, p.value) %>%
  mutate(stable_features = str_match(variable, "([a-z][:digit:]*)_*")[,2])
concordance[, 1:2]
```

```{r mldata}
concordance <- read_rds("/Users/colinccm/Documents/GitHub/Peres/MilesForMoffittRadiomics/concordance.rds") %>% 
  mutate(stable_features = str_match(namee, "([a-z][:digit:]*)_*")[,2])

stable_features <- paste0(paste(#"nor_", 
                                concordance$stable_features, "[a-z]", sep = ""), collapse = "|")

# rec_data <- read_rds(paste0(here::here(), "/radiomics.rds")) %>% 
#   filter(contrastenhancementyn == "yes") %>% 
#   select(mrn, matches(stable_features)) %>% 
#   inner_join(., clinical,
#              by = "mrn")
mldata <- rec_data %>% 
  select(treatment_type, recurrence_time, rec_event, matches(stable_features))

clinical <- clinical %>% 
  filter(str_detect(mrn, paste(rec_data$mrn, collapse = "|")))

# rec_data <- mldata %>% 
#   left_join(., clinical %>% 
#   select(mrn, rec_event, treatment_type,
#          debulking_status), 
#   by = "mrn")
```
<br>

<!-- ### Heatmap -->
```{r heatplot, fig.width=12}
# heatmap_data <- as.data.frame(mldata %>% full_join(., clinical %>%
#                                             select(mrn, tnm_cs_mixed_group_stage, raceeth)) ) %>%
#   distinct(mrn, .keep_all = TRUE)
# df1 <- heatmap_data %>%
#   unite(mrn, c(mrn, has_the_patient_recurred, tnm_cs_mixed_group_stage, raceeth), sep = "_", remove = TRUE) %>%
#   `row.names<-`(.$mrn) %>%
#   select(-mrn)
# 
# # Create matrix and drop NA, scale on patient
# df2 <- t(scale(t(as.matrix(df1)))) # scale for standardizing the data to make variables comparable
# 
# # Create colors for cluster
# condition_colors <- unlist(lapply(rownames(df2), function(x){
#   if(grepl("No Recurrence", x)) "grey"
#   else if(grepl("Recurrence", x)) "pink"
# }))
# 
# condition_colors1 <- unlist(lapply(rownames(df2), function(x){
#   case_when(
#     str_detect(x, "1") ~ "steelblue1",
#     str_detect(x, "2") ~ "black",
#     str_detect(x, "3") ~ "tan1",
#     str_detect(x, "4") ~ "orange",
#     TRUE          ~ NA_character_)
# }))
# 
# condition_colors2 <- unlist(lapply(rownames(df2), function(x){
#   case_when(
#     str_detect(x, "White") ~ "#03051AFF",
#     str_detect(x, "Black") ~ "red",
#     str_detect(x, "Hispanic") ~ "blue",
#     str_detect(x, "Other") ~ "darkgrey")
# }))
# 
# 
# mycols <- cbind(condition_colors, condition_colors1)
# 
# # Transpose
# df2 <- t(df2)
# 
# library(ComplexHeatmap)
# 
# column_ho = HeatmapAnnotation(raceeth = c(as.character(heatmap_data$raceeth)),
#                               outcome = (heatmap_data$has_the_patient_recurred), 
#                               col = list(raceeth = 
#                                            c("White Non-Hispanic" = "#932667FF", 
#                                              "Black Non-Hispanic" = "grey",
#                                              "Hispanic" = "blue", 
#                                              "Other/Unknown" = "pink"),
#                                          outcome = 
#                                            c("Recurrence" = "yellow", 
#                                              "No Recurrence" = "grey")
#                               ),
#     na_col = "black")
# Heatmap(df2, name = " ",
#         cluster_rows = FALSE, cluster_columns = FALSE,
#         top_annotation = column_ho
#         )
```
<br>
<br>

### Correlation

```{r, fig.height=12, fig.width=12}
# a <- mldata %>% select(matches("^f[0-9]"))
# p.mat <- cor_pmat(a)
# mat <- cor(a, use = "pairwise.complete.obs")
# ggcorrplot(mat, hc.order = TRUE, method = "square",
#            # p.mat = p.mat, # Barring the no significant coefficient
#            insig = "blank", # Leave blank on no significant coefficient
#            type = "lower",
#            lab = TRUE,
#            title = "Correlation between radiomics features",
#            show.legend = TRUE, legend.title = "Correlation", show.diag = TRUE,
#            # lab_col = "darkblue", lab_size = 3,
#            sig.level = 0.05, #insig = c("pch", "blank"), pch = 4, pch.col = "black", pch.cex = 10,
#            tl.cex = 10,
#            tl.srt = 90,
#            digits = 1,
#            outline.color = "white",
#   ggtheme = ggplot2::theme_gray,
#   colors = c("blue", "white", "#E46726")#6D9EC1
# )
```
<br>
<br>

***

<br>

# Data exploration
**We have now `r clinical %>% nrow()` patients in our cohort.**  

## Stydy population

<div class = "row">
<div class = "col-md-5">
```{r demo}
# rec_data %>%
#   full_join(., clinical) %>%
#   select(age_at_diagnosis, tnm_cs_mixed_group_stage, treatment_type, raceeth) %>%
#   tbl_summary(by = treatment_type) %>%
#   bold_labels() %>% add_p() %>% bold_p(t = 0.05)
```
</div>

<div class = "col-md-7">
```{r}
# p <- qplot(x =age_at_diagnosis, data=subset(clinical,!is.na(age_at_diagnosis)),
#            fill=..count.., geom="histogram", bins = 25)
# p + scale_fill_viridis_c(
#   alpha = 1,
#   begin = 0,
#   end = 1,
#   direction = 1,
#   option = "A",
#   values = NULL,
#   space = "Lab",
#   na.value = "grey50",
#   guide = "colourbar",
#   aesthetics = "fill"
# ) +
#   theme_minimal(base_size = 16) +
#   labs(x="Age at Diagnosis", y="Number of Patient", title="Repartition of Age at Diagnosis")
```
</div>
</div>

```{r}
# rec_data %>%
#   select(has_the_patient_recurred, treatment_type) %>%
#   tbl_summary(by = treatment_type,
#               sort = list(everything() ~ "frequency")
#               ) %>%
#   bold_labels() %>% add_p() %>% bold_p(t = 0.05)
```

<br>

<div class = "row">
<div class = "col-md-5">
```{r}
# rec_data %>%
#   ggplot(aes(x= recurrence_time, fill = has_the_patient_recurred)) +
#   geom_histogram(binwidth = 5, alpha = 0.8, position = "identity")+
#   scale_fill_manual(values=c("blue","red"))+
#   theme_minimal()+
#   labs(x = "recurrence time in month", fill='recurrence \nevent')
```
</div>

<div class = "col-md-7">
```{r}
# mldata %>%
#   ggplot(aes(x= has_the_patient_recurred)) +
#   geom_bar(fill = c("blue","red"), alpha = 0.8)+
#   coord_flip()+
#   theme_minimal()+
#   labs(x = NULL)+
#   ggtitle("Imbalanced data for recurrence outcome")
```
</div>
</div>

<br>
<br>

# Ask by Lauren : Survival curve by debulking status

```{r}
# mysurv <- Surv(rec_data$recurrence_time, event = rec_data$rec_event)
# myplot <- survfit(mysurv~debulking_status, data = rec_data)
# ggsurvplot(myplot, data = rec_data,
#            title = "Recurrence Analysis",
#            font.main = c(24, "bold", "black"),
#            font.x = c(20, "bold", "black"),
#            font.y = c(20, "bold", "black"),
#            font.legend = c(20, "bold", "black"),
#            font.tickslab = c(18, "bold", "black"),
#            size = 1.5,
# 
#            xlab = "Time in months",
#            legend = "top",
#            legend.title = "",
#            # legend.labs = c("White Non-Hispanic", "Hispanic", "Black"),
#            # palette = c("#03051AFF", "blue", "red"),
#            pval = TRUE,
#            pval.coord = c(0, 0.1),
#            conf.int = FALSE,
#            # xlim = c(0, 400),
#            # Censor
#            censor = TRUE
# ) + guides(colour = guide_legend(nrow = 4))
```
<br>


***

# Build a model

## Compare Adjuvant and Neo

```{r}
neo <- mldata %>% filter(treatment_type == "Upfront Neoadjuvant") %>% select(-treatment_type)
adj <-  mldata %>% filter(treatment_type == "Upfront Surgery") %>% select(-treatment_type)

adj_split <- initial_split(adj, prop = 3/4)
# Create training and testing datasets for Upfront Surgery:
train_adj <- training(adj_split)
test_adj  <- testing(adj_split)
```

### As Jaileene did
```{r}
z <- Surv(adj$recurrence_time, adj$rec_event)
z # z is dependent variable
fitsurv <- rpart::rpart(z ~ f65flatness + f80com_x_pxl + f85com_z_mm, data = adj, method = "exp")
fitsurv
plot(fitsurv)
text(fitsurv, use.n = TRUE, cex = 0.75, all = TRUE)
rpart.plot(fitsurv)
fancyRpartPlot(fitsurv)
path.rpart(fitsurv, node =2)

# Look at CP  
plotcp(fitsurv)
printcp(fitsurv)

# Update formula 
fitsurv <- rpart(z ~ f65flatness + f80com_x_pxl + f85com_z_mm, data = adj, method = "exp", control = rpart.control( cp= 0.038, #minsplit = , minbucket = , maxdepth = , 
                                                                                                                              xval = 10))
fitsurv
rpart.plot(fitsurv)
fancyRpartPlot(fitsurv)










fit_rpart <- rpart(
  Surv(recurrence_time, rec_event) ~ f65flatness + f80com_x_pxl + f85com_z_mm, 
  data = mldata , method = "exp")


# fitsurv <- rpart::rpart(z ~ f65flatness + f80com_x_pxl + f85com_z_mm, data = mldata, method = "exp")
fit_rpart
plot(fit_rpart)
text(fit_rpart, use.n = TRUE, cex = 0.75, all = TRUE)
rpart.plot(fit_rpart)
fancyRpartPlot(fit_rpart)
path.rpart(fit_rpart, node =2)

# Look at CP  
plotcp(fit_rpart)
printcp(fit_rpart)

# Update formula with cross val 10 fold
fitsurv <- rpart(
  Surv(recurrence_time, rec_event)~ f65flatness + f80com_x_pxl + f85com_z_mm, 
  data = adj, method = "exp", 
  control = rpart.control( cp= 0.022, #minsplit = , minbucket = , 
                           # maxdepth = 3, 
                           xval = 10))
fitsurv
rpart.plot(fitsurv)
fancyRpartPlot(fitsurv)


fit_rpart1 <- rpart(Surv(recurrence_time, rec_event)~ f65flatness + f80com_x_pxl + f85com_z_mm, data = neo , method = "exp")
```


I think that training and testing on the same data give bias results so it is better to train on a split data set of **Upfront surgery** then test on either split testing **Upfront surgery** and testing **Upfront Chemo** and compare statistics.
```{r}

```




## Splitting the data

The data is split in 3/4 for training and testing for better robustness.  
A strata is applied to the split function to balance has_the_patient_recurred in both sets.  
```{r}
```